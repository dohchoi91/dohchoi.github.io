---
title: "10.이벤트"
subtitle: "이벤트"
permalink: /notes/ddd-start/ch10
date: 2021-05-17 11:50
categories:
  - DDD START
tags:
  - java
last_modified_at: 2021-05-17 11:50
---
## 시스템 간 강결합의 문제
BOUNDED CONTEXT 간의 강결합은 설계나 로직 작성 등 다양한 문제를 야기시킨다. 
**⇒ 이런 강결합을 낮추는 방법으로 이벤트를 사용한다.**

## 이벤트
- 이벤트라는 용어는 '과거에 벌어진 어떤 것'을 뜻한다.
- 이벤트가 발생한다는 것은 상태가 변경됐다는 것을 의미한다.
- 도메인 모델에서 상태 변경을 이벤트로 표현 할수 있다.

### 이벤트 관련 구성 요소
도메인 모델에 이벤트를 도입하려면 네 개의 구성요소를 구현해야한다.
![image10-1.png](/assets/images/posts/ddd-start/image10-1.png)

- 도메인 모델에서 **이벤트 주체**는 엔티티, 밸류, 도메인 서비스와 같은 **도메인 객체**이다. 이들 도메인 객체는 로직을 실행해서 상태가 바뀌면 관련 이벤트를 발생한다.
- 이벤트 핸들러는 이벤트 생성 주체가 발생한 이벤트에 반응한다. 이벤트 핸들러는 생성 주체가 발생한 이벤트를 전달받아 이벤트에 담긴 데이터를 이용해서 원하는 기능을 실행한다.
- 이벤트 디스패처는 이벤트 생성 주체와 이벤트 핸들러를 연결해 준다. 구현 방식에 따라 동기, 비동기로 실행하게 한다.

### 이벤트의 구성
- 이벤트 종류 : 클래스 이름으로 이벤트 종류를 표현
- 이벤트 발생 시간
- 추가 데이터 : 주문번호, 신규배송지 정보 등 이벤티와 관련된 정보

### 이벤트 용도
1. 트리거
2. 서로 다른 시스템간의 데이터 동기화

### 이벤트 장점
서로 다른 도메인 로직이 섞이는 것을 방지 할 수 있다.

## 이벤트, 핸들러, 디스패처 구현
이벤트와 관련된 코드는 다음과 같다.

- 이벤트 클래스
- `EventHandler` : 모든 핸들러를 위한 상위 타입으로 모든 핸들러는 이 인터페이스를 구현한다.
- `Events` : 이벤트 디스패처. 이벤트 발생, 이벤트 핸들러 등록, 이벤트를 핸들러에 등록하는 등의 기능을 제공

### 이벤트 클래스
이벤트 자체를 위한 상위 타입은 존재하지 않는다. 이벤트는 과거에 벌어진 상태 변화나 사건을 의미하므로 네이밍 할 때 과거 시제를 사용 해야한다.

### EventHandler 인터페이스
이벤트 핸들러를 위한 상위 인터페이스다.

### 이벤트 디스패처인 Events 구현
도메인을 사용하는 응용 서비스는 이벤트를 받아 처리할 핸들러를 `Events.handle()`로 등록하고, 도메인 기능을 실행한다.

## 동기 이벤트 처리 문제
동기 이벤트로 처리하는 경우 **외부 서비스의 영향으로 내 시스템의 트랜잭션 범위 문제, 성능저하를 발생시키는 원인이 된다.**

## 비동기 이벤트 처리
이벤트를 비동기로 구현할 수 있는 방법은 다양하지만, 책에서는 다음 4가지 방식을 살펴본다.

- 로컬 핸들러를 비동기로 실행하기
- 메시지 큐를 사용하기
- 이벤트 저장소와 이벤트 포워더 사용하기
- 이벤트 저장소와 이벤트 제공 API 사용하기

### 로컬 핸들러를 비동기로 실행하기
이벤트 핸들러를 별도 스레드로 실행하게 한다.

### 메시징 시스템을 이용한 비동기 구현
이벤트가 발생시 이벤트 디스패처는 이벤트를 메시지 큐에 보낸다. 메시지 큐는 이벤트를 메시지 리스너에 전달하고, 메시지 리스너는 알맞은 이벤트 핸들러를 이용해서 이벤트를 처리한다.
![image10-2.png](/assets/images/posts/ddd-start/image10-2.png)

### 이벤트 저장소를 이용한 비동기 처리
우선 이벤트를 DB에 저장한 뒤에 별도 프로그램을 이용해서 이벤트 핸들러에 전달
![image10-3.png](/assets/images/posts/ddd-start/image10-3.png)
혹은 이벤트를 외부에 제공하는 API를 사용한다.
![image10-4.png](/assets/images/posts/ddd-start/image10-4.png)

API 방식과 포워더 방식의 차이점은 이벤트를 전달하는 방식에 있다. 포워더 방식에서는 포워더를 이용해서 이벤트를 외부에 전달하는 방식이라면, API방식에서는 외부 핸들러가 API서버를 통해 이벤트 목록을 가져오는 방식이다. 포워더 방식은 이벤트를 어디까지 처리했는지 추적하는 역할이 포워더에 있다면, API 방식에서는 이벤트 목록을 요구하는 외부 핸들러가 자신이 어디까지 이벤트를 처리했는지 기억해야 한다.

## 이벤트 적용 시 추가 고려사항
1. 이벤트 발생 주체구체 추가 여부
2. 포워더에서 전송 실패의 허용 범위
3. 이벤트 손실
4. 이벤트 순서
5. 이벤트 재처리